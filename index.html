<!DOCTYPE html5>
<html>
  <head>
    <script>
    // NASTAVENÍ //

    // API uživatelské jméno a heslo :: automatické přihlášení //
    var APIuser = "";
    var APIpass = "";

    // Zamknutá čísla :: čárkou oddělený seznam zkratek (klapek), které nejde editovat //
    // př. var lockedNumbers = "1,7" // zakáže čísla 1 a 7
    var lockedNumbers = "";

    // Skrytí zamknutých čísel :: true = nezobrazovat vůbec, false = zobrazit, ale zakázat úpravy //
    // př. var hideLockedNumbers = true // nezobrazí vůbec 
    var hideLockedNumbers = true;

    // Povolit přidávání nových čísel :: true = povolit, false = zakázat //
    // př. var enableAdding = false // zakáže přidávání
    var enableAdding = true;

    // Povolit upravování nových čísel :: true = povolit, false = zakázat //
    // př. var enableEditing = true // povolí úpravy
    var enableEditing = true;

    // Povolit mazání nových čísel :: true = povolit, false = zakázat //
    // př. var enableRemoving = false // zakáže mazání
    var enableRemoving = true;

    // Povolit callback :: true = povolit, false = zakázat //
    // př. var enableCallback = false // zakáže callback
    var enableCallback = true;

    // Povolit políčko rychlého callbacku :: true = povolit, false = zakázat //
    // př. var enableQuickCallback = false // zakáže políčko callbacku
    var enableQuickCallback = true;

    // Povolit odhlašovaní uživatele :: true = povolit, false = zakázat //
    // př. var enableLogout = false // zakáže odhlašování
    var enableLogout = true;

    // Povolit import/export :: true = povolit, false = zakázat //
    // př. var enableLogout = false // zakáže import/export
    var enableImportExport = true;

    // Povolit úpravu přímo v tabulce :: true = povolit, false = zakázat //
    // Klepněte dvakrát na políčko textu v tabulce a můžete ho přímo upravit //
    // př. var enableInlineEditing = false // zakáže úpravy přímo v tabulce
    var enableInlineEditing = true;

    // Povolit animace :: true = povolit, false = zakázat //
    // př. var enableAnimations = false // zakáže animace
    var enableAnimations = true;

    // Přednastavené číslo pro callback //
    // př. var defaultCallbackNumber = "0085023815827"; // nastaví výchozí číslo pro callback na 0085023815827
    var defaultCallbackNumber = "";

    // Povolit tmavé téma :: true = povolit, false = zakázat //
    // Vhodné pro osoby se zrakovými problémy //
    // př. var darkTheme = true // povolí tmavé téma
    var darkTheme = false;

    // KONEC NASTAVENÍ //
    // Pokud chcete upravit nějaké názvy, můžete v HTML kódu níže.
    </script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Odorik: Rychlé kontakty</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/button.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/container.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/dimmer.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/dropdown.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/form.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/grid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/header.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/icon.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/input.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/label.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/loader.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/message.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/menu.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/modal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/reset.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/segment.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/site.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/table.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/transition.min.css">
    <link href='https://fonts.googleapis.com/css?family=Lato&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <div id="warningIE" style="padding-top: 10%; background: white; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; padding: 15px; text-align: center">
        <p>Používáte zastaralý prohlížeč. Nainstalujte si Google Chrome nebo Mozillu Firefox.</p>
    </div>
    <div class="ui container" style="display: none;">
        <!-- TITLE -->
        <h1 class="ui header">
            <br>Odorik.cz
            <div class="sub header">Rychlé kontakty <div class="ui orange label">BETA 1.4</div></div>
        </h1>
        <script>
        if (enableAdding && enableLogout && enableQuickCallback) {
            document.write('<div class="ui secondary menu">');
        }
        if (enableAdding) {
            document.write('<div class="item fitted"><button class="ui green button" onclick="addContact();"><i class="plus icon"></i> Přidat</button></div>');
        }
        if (enableImportExport) {
            document.write('<div class="item fitted"><button class="ui button" onclick="importExportModal();"><i class="file archive outline icon"></i> Import/Export</button></div>');
        }
        if (enableLogout) {
            document.write('<div class="item fitted"><button class="ui button" onclick="logoutModal();"><i class="sign out icon"></i> Odhlásit</button></div>');
        }
        if (enableQuickCallback) {
            document.write('<div class="right item fitted"><div class="ui action input"><input type="text" name="quick-input" placeholder="Volané číslo"><button id="quick-button" class="ui button"><i class="call icon"></i> Callback</button></div></div>');
        }
        if (enableAdding && enableLogout && enableQuickCallback) {
            document.write('</div>');
        }
        </script>
        <!-- TABLE -->
        <table class="ui celled compact table" id="tableWrapper">
            <thead>
                <tr>
                    <th>Zkratka</th>
                    <th>Název</th>
                    <th>Číslo</th>
                    <th class="one wide"></th>
                </tr>
            </thead>
            <tbody id="table">
            </tbody>
        </table>
    </div>
    <!-- DELETE MODAL -->
    <div class="ui modal" id="deleteModal">
        <i class="close icon"></i>
        <div class="header">
            Smazat kontakt
        </div>
        <div class="content">
            <div class="description">
                <p>Opravdu chcete smazat tento rychlý kontakt?</p>
            </div>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Ne
            </div>
            <div class="ui positive right labeled icon button">
                Smazat
                <i class="trash icon"></i>
            </div>
        </div>
    </div>
    <!-- EDIT MODAL -->
    <div class="ui modal" id="editModal">
        <i class="close icon"></i>
        <div class="header">
            Upravit kontakt
        </div>
        <div class="content">
            <form class="ui form">
                <div class="field">
                    <label>Zkratka</label>
                    <input type="text" name="edit-shortcut">
                </div>
                <div class="field">
                    <label>Název</label>
                    <input type="text" name="edit-name">
                </div>
                <div class="field">
                    <label>Číslo</label>
                    <input type="text" name="edit-number">
                </div>
            </form>
            <p><b>TIP: </b>Lze editovat i dvojklikem na hlavní stránce.</p>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Zrušit
            </div>
            <div class="ui positive right labeled icon button">
                Upravit
                <i class="checkmark icon"></i>
            </div>
        </div>
    </div>
    <!-- ADD MODAL -->
    <div class="ui modal" id="addModal">
        <i class="close icon"></i>
        <div class="header">
            Přidat kontakt
        </div>
        <div class="content">
            <form class="ui form">
                <div class="field">
                    <label>Zkratka</label>
                    <input type="text" name="add-shortcut" placeholder="Zkratka">
                </div>
                <div class="field">
                    <label>Název</label>
                    <input type="text" name="add-name" placeholder="Název">
                </div>
                <div class="field">
                    <label>Číslo</label>
                    <input type="text" name="add-number" placeholder="Číslo">
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Zrušit
            </div>
            <div class="ui positive right labeled icon button">
                Přidat
                <i class="checkmark icon"></i>
            </div>
        </div>
    </div>
    <!-- LOGOUT MODAL -->
    <div class="ui modal" id="logoutModal">
        <i class="close icon"></i>
        <div class="header">
            Odhlášení
        </div>
        <div class="content">
            <div class="description">
                <p>Opravdu se chcete odhlásit? Budete muset znovu zadat API jméno a heslo.</p>
            </div>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Zrušit
            </div>
            <div class="ui positive right labeled icon button">
                Odhlásit
                <i class="sign out icon"></i>
            </div>
        </div>
    </div>
    <!-- LOGIN MODAL -->
    <div class="ui small modal" id="loginModal">
        <div class="header">
          Odorik.cz -  API WEB - správa rychlých kontaktů
        </div>
        <div class="content">
            <p>API jméno a heslo najdete po přihlášení v menu  <a href="https://www.odorik.cz/ucet/nastaveni_uctu.html?ucet_podmenu=api_heslo" target="_blank">nastavení účtu <i class="ui angle right icon"></i>API heslo.</a></p>
            <form class="ui form">
                <div class="field">
                    <label>API jméno</label>
                    <input type="text" name="login-name">
                </div>
                <div class="field">
                    <label>API heslo</label>
                    <input type="password" name="login-pass">
                </div>
            </form>
            <div class="ui negative message" id="badLogin" style="display: none;">
                <div class="header">Nesprávné uživatelské jméno nebo heslo.</div>
            </div>              
            <a href="https://github.com/martykan/odorik/blob/gh-pages/index.html">Zdrojový kód</a> této "single page" aplikace je k dispozici <a href="https://github.com/martykan/odorik">včetně dokumentace</a>. Můžete si jej sami nechat upravit a integrovat  např. do vlastních webových stránek.
        </div>
        <div class="actions">
            <div class="ui positive right labeled icon button">
                Přihlásit se
                <i class="sign in icon"></i>
            </div>
        </div>
    </div>
    <!-- CALL MODAL -->
    <div class="ui modal" id="callModal">
        <i class="close icon"></i>
        <div class="header">
            Objednat callback
        </div>
        <div class="content">
            <form class="ui form">
                <div class="field">
                    <label>Volané číslo</label>
                    <input type="text" name="call-target" disabled>
                </div>
                <div class="field">
                    <label>Vaše číslo</label>
                    <div class="ui input">
                        <input type="text" name="call-number" placeholder="Číslo">
                        <!--<div class="ui button" onclick=""><i class="user icon"></i>Kontakty</div>-->
                    </div>
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Zrušit
            </div>
            <div class="ui positive right labeled icon button">
                Volat
                <i class="checkmark icon"></i>
            </div>
        </div>
    </div>
    <!-- IMPORT/EXPORT MODAL -->
    <div class="ui modal" id="importExportModal">
        <i class="close icon"></i>
        <div class="header">
            Import/Export
        </div>
        <div class="content">
            <div class="description">
                <p>Tato aplikace umožňuje import a export kontaktů ve formátu <b>vCard</b>.</p>
                <p>Pokud chcete importovat data z Google kontaktů:</p>
                <ol>
                  <li>Na stránce <a href="https://www.google.com/contacts/u/0/?cplus=0#contacts" target="_blank">google.com/contacts</a> vyberte kontakty.
                  <li>Klikněte na <b>Další</b>, a pak <b>Exportovat...</b>. </li>
                  <li>V následujicím okně vyberte formát exportu <b>vCard</b> a stáhněte a uložte soubor s kontakty kliknutím na tlačítko <b>Exportovat</b>.</li>
                  <li>Níže v tomto okně klikněte na tlačítko <b>Importovat</b> a vyberte připravený soubor s kontakty.</li>
                  <li>Jako čísla zkratek budou navrženy následující volné pozice, případně budou použita čísla uložená v poli <b>poznámka</b> u jednotlivých kontaktů.
                      Před uložením dostanete  možnost si vše prohlédnout a ručně upravit, případně import zrušit.
         </li>
                </ol>
                <input id="fileinput" type="file" name="fileinput" style="display: none;" />
            </div>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Zrušit
            </div>
            <div class="ui blue deny right labeled icon button" id="exportButton">
                Exportovat
                <i class="download icon"></i>
            </div>
            <div class="ui green right labeled icon button" id="importButton">
                Importovat
                <i class="wizard icon"></i>
            </div>
        </div>
    </div>
    <!-- IMPORT WIZARD MODAL -->
    <div class="ui modal" id="importWizardModal">
        <i class="close icon"></i>
        <div class="header">
            Import
        </div>
        <div class="content">
            <p>Čísla zkratek i texty k číslům si můžete libovolně upravit. Pokud chcete kontakt vynechat, nastavte jeho zkratku na nulu.</p>
            <p><b>Pozor:</b> Pokud navržená čísla zkratek změníte, může se stát, že si následným uložením přepíšete existující záznamy pod stejným číslem.
                             Budete na to upozorněni zčervenáním čísla zkratky po opuštění editačního pole.</p>
            <table class="ui celled compact table" id="tableWrapper">
                <thead>
                    <tr>
                        <th class="two wide">Zkratka</th>
                        <th>Název</th>
                        <th>Číslo</th>
                    </tr>
                </thead>
                <tbody id="tableImport">
                </tbody>
            </table>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Zrušit
            </div>
            <div class="ui positive right labeled icon button">
                Dokončit
                <i class="checkmark icon"></i>
            </div>
        </div>
    </div>
    <!-- DIMMERS -->
    <div class="ui page dimmer">
      <div class="content">
        <div class="center">
            <h1 class="ui inverted icon header">
          <i class="checkmark icon"></i>
          <small></small>
         </h1>
        </div>
      </div>
    </div>
    <!-- SCRIPTS -->
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/semantic.min.js"></script>
    <script>
    // Disable caching of AJAX responses (so the data is properly updated)
    $.ajaxSetup({
        cache: false
    });

    // Initialize helper variables
    var number;
    var array;
    
    if(darkTheme){
        $("body").css("background", "#333");
        $(".header").css("color", "#fff");
    }

    if (enableAnimations) {
        var setDuration = 400;
    } else {
        var setDuration = 0;
    }

    // Is user logged in?
    if (loggedIn()) {
        init(); // Load page
    } else {
        logInDialog(); // Show login dialog
    }

    var allNumbers = [];
    var allShortcuts = [];

    // Detect if user is logged in 
    function loggedIn() {
        // Is the data in localStorage?
        if (localStorage.getItem('username') !== null && localStorage.getItem('password') !== null || (APIuser != "" && APIpass != "")) {
            if (localStorage.getItem('username') !== null && localStorage.getItem('password') !== null) {
                APIuser = localStorage.getItem('username');
                APIpass = localStorage.getItem('password');
            }

            // Is the data valid?           
            $.ajax({
                url: 'https://www.odorik.cz/api/v1/lines',
                type: 'GET',
                data: {
                    user: APIuser,
                    password: APIpass
                },
                success: function(result) {
                    // Check if there are any errors
                    if (result.indexOf("error") == -1) {
                        // No errors
                    } else {
                        // Logout and try again
                        logout();
                    }
                }
            });
            return true;
        } else {
            return false;
        }
    }

    // Show login dialog
    function logInDialog() {
        // Initialitze helper variable
        badlogin = false;
        // Show the dialog
        $('#loginModal').modal({
            closable: false,
            duration: setDuration,
            blurring: true,
            onApprove: function() {
                // Animate button
                $("#loginModal .button").addClass("loading");

                // Get values from fields
                APIuser = $('input[name="login-name"]').val();
                APIpass = $('input[name="login-pass"]').val();

                // Connect to API
                $.ajax({
                    url: 'https://www.odorik.cz/api/v1/lines',
                    type: 'GET',
                    data: {
                        user: APIuser,
                        password: APIpass
                    },
                    success: function(result) {
                        // Stop button animation
                        $("#loginModal .button").removeClass("loading");
                        // Check if there are any errors
                        if (result.indexOf("error") == 0) {
                            // Show error animations
                            $("#loginModal").transition('shake', setDuration + "ms");
                            if (badlogin)
                                $('#badLogin').transition("pulse", setDuration + "ms");
                            else {
                                $('#badLogin').transition("fade", setDuration + "ms");
                                badlogin = true;
                            }
                        } else {
                            // Hide and log in
                            $('#loginModal').modal('hide');
                            init();

                            localStorage.setItem('username', APIuser);
                            localStorage.setItem('password', APIpass);
                        }
                    }
                });

                return false;
            }
        }).modal('show');
    }

    // Log out the user
    function logoutModal() {
        $('#logoutModal').modal({
            blurring: true,
            duration: setDuration,
            onApprove: function() {
                logout();
            }
        }).modal('show');
    }

    // Log out the user
    function logout() {
        localStorage.removeItem('username');
        localStorage.removeItem('password');

        location.reload();
    }

    // Initialization
    function init() {
        $("input[name=call-number]").val(defaultCallbackNumber);

        // Initialize speed dials
        reload();
    }

    // Remove Contact
    function removeContact(line, id) {
        $('#deleteModal').modal({
            duration: setDuration,
            blurring: true,
            onApprove: function() {
                if (line == "main") {
                    requestURL = 'https://www.odorik.cz/api/v1/speed_dials/' + id + '.json';
                } else {
                    requestURL = "https://www.odorik.cz/api/v1/lines/" + line + '/speed_dials/' + id + '.json';
                }
                $.ajax({
                    url: requestURL,
                    type: 'DELETE',
                    data: {
                        user: APIuser,
                        password: APIpass
                    },
                    success: function(result) {
                        if (typeof result.errors != "undefined") {
                            parseErrors(result);
                        }
                        setTimeout("reload();", 500);
                    }
                });
            }
        }).modal('show');
    }

    // Edit Contact
    function editContact(line, id, name, number) {
        $('input[name="edit-shortcut"]').val(id);
        $('input[name="edit-name"]').val(name);
        $('input[name="edit-number"]').val(number);
        $('#editModal').modal({
            duration: setDuration,
            blurring: true,
            onApprove: function() {
                if (line == "main") {
                    requestURL = 'https://www.odorik.cz/api/v1/speed_dials/' + id + '.json';
                } else {
                    requestURL = "https://www.odorik.cz/api/v1/lines/" + line + '/speed_dials/' + id + '.json';
                }
                $.ajax({
                    url: requestURL,
                    type: 'PUT',
                    data: {
                        user: APIuser,
                        password: APIpass,
                        shortcut: $('input[name="edit-shortcut"]').val(),
                        name: $('input[name="edit-name"]').val(),
                        number: $('input[name="edit-number"]').val()
                    },
                    success: function(result) {
                        if (typeof result.errors != "undefined") {
                            parseErrors(result);
                        }
                        setTimeout("reload();", 500);
                    }
                });
            }
        }).modal('show');
    }

    // Add Contact
    function addContact() {
        $('#addModal').modal({
            duration: setDuration,
            blurring: true,
            onApprove: function() {
                requestURL = 'https://www.odorik.cz/api/v1/speed_dials.json';
                $.ajax({
                    url: requestURL,
                    type: 'POST',
                    data: {
                        user: APIuser,
                        password: APIpass,
                        shortcut: $('input[name="add-shortcut"]').val(),
                        name: $('input[name="add-name"]').val(),
                        number: $('input[name="add-number"]').val()
                    },
                    success: function(result) {
                        if (typeof result.errors != "undefined") {
                            parseErrors(result);
                        }
                        setTimeout("reload();", 500);
                    }
                });
            }
        }).modal('show');
    }

    // Parse errors
    function parseErrors(resp) {
        var error = resp.errors[0];
        if (error.indexOf("unauthorized") >= 0) {
            showError("Nejste autorizováni k provedení této operace.");
        }
        if (error.indexOf("invalid_number") >= 0) {
            showError("Neplatné číslo.");
        }
        if (error.indexOf("invalid_shortcut") >= 0) {
            showError("Neplatná zkratka.");
        }
        if (error.indexOf("name_too_long") >= 0) {
            showError("Název je příliš dlouhý.");
        }
        if (error.indexOf("shortcut_already_used") >= 0) {
            showError("Zkratka je už použitá.");
        }
        if (error.indexOf("speed_dials_full") >= 0) {
            showError("Rychlé kontakty jsou už plné.");
        }
    }

    // Display errors
    function showError(message) {
        dim(false, message);
    }

    // Detect uneditable lines
    function editableLine(line, number) {
        return $.inArray(number + "", lockedNumbers.split(",")) == -1;
    }

    // Reload list
    function reload() {
        allShortcuts = [];
        allNumbers = [];
        $.ajax({
            url: 'https://www.odorik.cz/api/v1/speed_dials.json',
            type: 'GET',
            data: {
                user: APIuser,
                password: APIpass
            },
            success: function(result) {
                array = result;
                outstring = "";
                for (var i = 0; i < result.length; i++) {
                    allNumbers.push(result[i].number);
                    allShortcuts.push(result[i].shortcut);
                    if (editableLine("main", result[i].shortcut)) {
                        outstring += '<tr><td class="table-short-'+result[i].shortcut+'">' + result[i].shortcut + '</td>' + '<td class="table-name-'+result[i].shortcut+'">' + result[i].name + '</td><td class="table-num-'+result[i].shortcut+'">' + result[i].number + '</td><td>';

                        if (enableEditing || enableRemoving || enableCallback)
                            outstring += '<div class="ui icon buttons">';

                        if (enableRemoving)
                            outstring += '<button class="ui red button" onclick="removeContact(\'main\', \'' + result[i].shortcut + '\')"><i class="delete icon"></i></button>';

                        if (enableEditing)
                            outstring += '<button class="ui blue button" onclick="editContact(\'main\', \'' + result[i].shortcut + '\',\'' + result[i].name + '\',\'' + result[i].number + '\')"><i class="edit icon"></i></button>';

                        if (enableCallback)
                            outstring += '<button class="ui green button" onclick="callBack(\'' + result[i].number + '\',\'' + result[i].shortcut + '\',\'' + result[i].name + '\')"><i class="call icon"></i></button>';

                        if (enableEditing || enableRemoving || enableCallback)
                            outstring += '</div>'

                        outstring += '</td></tr>';
                    } else {
                        if (hideLockedNumbers == false) {
                            outstring += '<tr><td class="table-short-'+result[i].shortcut+'">' + result[i].shortcut + '</td>' + '<td class="table-name-'+result[i].shortcut+'">' + result[i].name + '</td><td class="table-num-'+result[i].shortcut+'">' + result[i].number + '</td><td>';
                            outstring += '<div class="ui icon buttons">' + '<button class="ui red button" disabled><i class="delete icon"></i></button>' + '<button class="ui blue button" disabled><i class="edit icon"></i></button>' + '<button class="ui green button" disabled><i class="call icon"></i></button></div>';
                            outstring += '</td></tr>';
                        }
                    }

                }
                $("#table").html(outstring);
                if ($(".ui.container").css("display") == "none") {
                    $(".ui.container").transition("fade", setDuration + "ms");
                }

                if(enableInlineEditing){
                    $("#table td").dblclick(function(){
                        $(".edited").each(function(){
                            $(this).text($(this).find("input").attr("data-original"));
                        });
                        $(".edited").removeClass("edited");
                        $(this).addClass("edited");

                        $(this).html("<div class='ui icon fluid input'><input type='text' data-original='"+$(this).text()+"' id='inlineInput' value='"+$(this).text()+"'><i id='inlineSubmit' class='link checkmark icon'></i></div>");

                        var id = $(this).attr("class").replace(" edited", "").split("-")[2];

                        $("#inlineInput").keypress(function(e) {
                            if (e.which == 13) {
                                inlineEdit(id);
                            }
                        });
                        $("#inlineSubmit").click(function(){
                            inlineEdit(id);
                        });
                    });
                }
            }
        });
    }

    function inlineEdit(id){
        $(".edited").each(function(){
            $(this).text($(this).find("input").val());
        });
        console.log($('.table-name-'+id).text());
        $(".edited").removeClass("edited");
        $.ajax({
            url: 'https://www.odorik.cz/api/v1/speed_dials/' + id + '.json',
            type: 'PUT',
            data: {
                user: APIuser,
                password: APIpass,
                shortcut: $('.table-short-' +id).text(),
                name: $('.table-name-'+id).text(),
                number: $('.table-num-'+id).text()
            },
            success: function(result) {
                if (typeof result.errors != "undefined") {
                    parseErrors(result);
                }
                setTimeout("reload();", 500);
            }
        });
    }

    // Call back
    function callBack(number, shortcut, name) {
        if (typeof shortcut !== "undefined") {
            $('input[name="call-target"]').val(number + " - zk. " + shortcut + " (" + name + ")");
        } else {
            $('input[name="call-target"]').val(number);
        }

        $('#callModal').modal({
            duration: setDuration,
            blurring: true,
            onApprove: function() {
                line = $('select[name="call-line"]').val();
                requestURL = 'https://www.odorik.cz/api/v1/callback';

                $.ajax({
                    url: requestURL,
                    type: 'POST',
                    data: {
                        user: APIuser,
                        password: APIpass,
                        caller: $('input[name="call-number"]').val(),
                        recipient: number,
                        line: line
                    },
                    success: function(result) {
                        if (result.indexOf("error") != 0) {
                            dim(true, "Callback obědnán");
                        } else {
                            dim(false, "Došlo k chybě. Zkontrolujte zadané číslo.");
                        }
                    }
                });
            }
        }).modal('show');
    }

    // Quick Callback input box
    $("input[name=quick-input]").keypress(function(e) {
        if (e.which == 13) {
            callBack($("input[name=quick-input]").val());
        }
    });
    $("#quick-button").click(function(event) {
        callBack($("input[name=quick-input]").val());
    });

    // Shows "dimmer" element - for displaying error messages
    function dim(status, text) {
        if (status == true) {
            $('.page.dimmer h1 i').removeClass("warning");
            $('.page.dimmer h1 i').removeClass("sign");
            $('.page.dimmer h1 i').removeClass("checkmark");
            $('.page.dimmer h1 i').addClass("checkmark");
        } else {
            $('.page.dimmer h1 i').removeClass("warning");
            $('.page.dimmer h1 i').removeClass("sign");
            $('.page.dimmer h1 i').removeClass("checkmark");
            $('.page.dimmer h1 i').addClass("warning");
            $('.page.dimmer h1 i').addClass("sign");
        }
        $('.page.dimmer small').html(text);
        setTimeout("$('.page.dimmer').dimmer('show');", 800)
        setTimeout("$('.page.dimmer').dimmer('hide');", 2100);
    }

    // Incompatible browser warning
    if (window.navigator.userAgent.indexOf("MSIE") == -1) {
        document.write("<style type='text/css'>#warningIE {display:none;}</style>");
        $("#warningIE").hide();
    }

    // Import/Export modal
    function importExportModal() {
        $('#importExportModal').modal({
            duration: setDuration,
            blurring: true
        }).modal('show');
    }

    // Read file
    $("#importButton").click(function() {
        $("#importButton").addClass("loading");
        $("#fileinput").trigger("click");
        if (window.File && window.FileReader && window.FileList && window.Blob) {
            $("#fileinput").change(function(event) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var text = reader.result;
                    if(text.indexOf("VCARD") > 0){
                        importVCard(text);
                    }
                    else {
                        alert("Toto není platný soubor vCard");
                    }
                }

                reader.readAsText(event.target.files[0], "utf-8");
            });
        } else {
            dim(false, "Váš prohlížeč nepodporuje API souborů");
        }
    });

    // Parse vCard
    function parse(input) {
        var Re1 = /^(version|fn|title|org|note):(.+)$/i;
        var Re2 = /^([^:;]+);([^:]+):(.+)$/;
        var ReKey = /item\d{1,2}\./;
        var fields = {};

        input.split(/\r\n|\r|\n/).forEach(function(line) {
            var results, key;

            if (Re1.test(line)) {
                results = line.match(Re1);
                key = results[1].toLowerCase();
                fields[key] = results[2];
            } else if (Re2.test(line)) {
                results = line.match(Re2);
                key = results[1].replace(ReKey, '').toLowerCase();

                var meta = {};
                results[2].split(';')
                    .map(function(p, i) {
                        var match = p.match(/([a-z]+)=(.*)/i);
                        if (match) {
                            return [match[1], match[2]];
                        } else {
                            return ["TYPE" + (i === 0 ? "" : i), p];
                        }
                    })
                    .forEach(function(p) {
                        meta[p[0]] = p[1];
                    });

                if (!fields[key]) fields[key] = [];

                fields[key].push({
                    meta: meta,
                    value: results[3].split(';')
                })
            }
        });

        return fields;
    };

    // Helper function for replacing strings
    function replaceAll(find, replace, str) {
        return str.replace(new RegExp(find, 'g'), replace);
    }

    // Unify phone number formats
    function unifyNumber(input) {
        input = replaceAll(" ", "", input);
        input = replaceAll("-", "", input);
        input = input.replace("+", "00");

        if (input.length != 6) {
            if (input.indexOf("00") != 0) {
                input = "00420" + input;
            }
        }

        return input;
    }

    // Separate into individual contacts
    function separate(input) {
        card = [];
        array = input.split("END:VCARD");
        for (i = 0; i < array.length; i++) {
            card[i] = parse(array[i] + "END:VCARD");
        }
        return card;
    }


    // Import Wizard modal
    function importVCard(input) {
        // Clear table
        $("#tableImport").html("");
        // Initialize helper variables
        var usedShortcuts = [];
        var usedNumbers = [];
        var contacts = separate(replaceAll("TEL:", "TEL;TYPE=HOME:", input));
        var totalCount = 0;
        // Loop through individual contacts
        for (i = 0; i < contacts.length; i++) {
            contact = contacts[i];
            // Check if number and name is set
            if (typeof contact.tel != "undefined" && typeof contact.fn != "undefined") {
                // Loop through specific phone numbers
                    for (a = 0; a < contact.tel.length; a++) {
                        if($.inArray(unifyNumber(contact.tel[a].value[0]), usedNumbers) == -1){
                            usedNumbers.push(unifyNumber(contact.tel[a].value[0]));
                            totalCount += 1;
                            var shortcut = "";
                            // Check if the shortcut is defined and if not, define it
                            if (typeof contact.note == "undefined" || isNaN(contact.note)) {
                                shortcut = totalCount;
                                while($.inArray(shortcut, allShortcuts) > -1 || $.inArray(shortcut, usedShortcuts) > -1 || shortcut < 200 && shortcut > 99){
                                    shortcut = shortcut + 1;
                                }
                            } else {
                                shortcut = contact.note;
                            }
                            usedShortcuts.push(shortcut);
                            // Add a description
                            var type = "";
                            if(contact.tel.length > 1){
                                console.log("multiple");
                                console.log(contact.tel[a].meta);
                                if(contact.tel[a].meta.TYPE == "HOME"){
                                    type = " (domů)"
                                }
                                if(contact.tel[a].meta.TYPE == "WORK"){
                                    type = " (práce)"
                                }
                                if(contact.tel[a].meta.TYPE == "CELL"){
                                    type = " (mobil)"
                                }
                                if(contact.tel[a].meta.TYPE == "FAX"){
                                    type = " (fax)"
                                }
                            }
                            // Warn against conflicts in shortcuts
                            var warning = "";
                            if($.inArray(Number(shortcut), allShortcuts) > -1){
                                warning = "error";
                            }
                            // Append to table
                            $("#tableImport").append("<tr class='"+ warning +"'><td><div class='ui transparent left icon fluid "+ warning +" input'><i style='display: none' class='remove icon'></i><input class='shortuctImport' id='import-shortuct" + i + "' type='number' min='1' value='" + shortcut + "'></div></td>" + "<td><div class='ui transparent fluid input'><input id='import-name" + i + "' value='" + contact.fn + type + "'></div></td>" + "<td><div class='ui transparent fluid input'><input id='import-number" + i + "' type='tel' value='" + unifyNumber(contact.tel[a].value[0]) + "'></div></td></tr>");
                            }
                        }
                    // Check for change in shortcuts and hide conflict warnings
                    $(".shortuctImport").change(function(){
                        if($.inArray(Number($(this).val()), allShortcuts) == -1){
                            $(this).parent().removeClass("error");
                            $(this).parent().parent().removeClass("error");
                            $(this).parent().parent().find("i").hide();
                        }
                        else {
                            $(this).parent().addClass("error");
                            $(this).parent().parent().addClass("error");
                            $(this).parent().parent().find("i").show();
                        }
                    });
            }
        }
        $("#importButton").removeClass("loading");
        // Show modal with table
        $("#importWizardModal").modal({
            duration: setDuration,
            onApprove: function() {
                // Loop through entries and save them
                for (i = 0; i < contacts.length; i++) {
                    if (typeof $("#import-shortuct" + i).val() != "undefined") {
                        $.ajax({
                            url: 'https://www.odorik.cz/api/v1/speed_dials.json',
                            type: 'POST',
                            data: {
                                user: APIuser,
                                password: APIpass,
                                shortcut: $("#import-shortuct" + i).val(),
                                name: $("#import-name" + i).val(),
                                number: $("#import-number" + i).val()
                            },
                        });
                    }
                }
                setTimeout("reload();", 1200);
            }
        }).modal("show");
    }

    // Save file function
    var saveData = (function() {
        var a = document.createElement("a");
        document.body.appendChild(a);
        a.style = "display: none";
        return function(data, fileName) {
            var json = data,
                blob = new Blob([json], {
                    type: "octet/stream"
                }),
                url = window.URL.createObjectURL(blob);
            a.href = url;
            a.download = fileName;
            a.click();
            window.URL.revokeObjectURL(url);
        };
    }());

    // Export
    $("#exportButton").click(function() {
        $.ajax({
            url: 'https://www.odorik.cz/api/v1/speed_dials.json',
            type: 'GET',
            data: {
                user: APIuser,
                password: APIpass
            },
            success: function(result) {
                array = result;
                outstring = "";
                for (var i = 0; i < result.length; i++) {
                    outstring += "BEGIN:VCARD\r\n";
                    outstring += "VERSION:3.0\r\n";
                    outstring += "FN:" + result[i].name + "\r\n";
                    outstring += "TEL;TYPE=CELL:" + result[i].number + "\r\n";
                    outstring += "NOTE:" + result[i].shortcut + "\r\n";
                    outstring += "END:VCARD\r\n";
                }
                saveData(outstring, "Kontakty.vcf")

            }
        });
    });

    $("#addModal input").keypress(function(e){
        if (e.which == 13) {
            $("#addModal .positive").click();
        }
    });

    $("#editModal input").keypress(function(e){
        if (e.which == 13) {
            $("#editModal .positive").click();
        }
    });

    $("#loginModal input").keypress(function(e){
        if (e.which == 13) {
            $("#loginModal .positive").click();
        }
    });

    </script>
  </body>
</html>
